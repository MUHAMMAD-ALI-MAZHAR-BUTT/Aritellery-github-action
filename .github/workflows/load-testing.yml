name: Load Test Runner

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (signet/mainnet)"
        required: true
        type: choice
        options: [signet, mainnet]
      run-mode:
        description: "Run single test or all tests?"
        required: true
        type: choice
        options: [single, all]
      test-case:
        description: "Test config filename (without .yml) - required if 'single' mode"
        required: false
        type: string
        default: ""

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      test-cases: ${{ steps.get-tests.outputs.test-cases }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Discover test cases
        id: get-tests
        run: |
          if [[ "${{ inputs.run-mode }}" == "all" ]]; then
            tests=$(find test/load/configs -name "*.yml" -exec basename {} .yml \; | jq -R -s -c 'split("\n") | map(select(. != ""))')
          else
            tests="[\"${{ inputs.test-case }}\"]"
          fi
          echo "test-cases=$tests" >> $GITHUB_OUTPUT

  load-test:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-case: ${{ fromJSON(needs.setup.outputs.test-cases) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Setup Node.js & Artillery
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
      - run: npm install -g artillery@latest

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS CLI
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.TESTNET_S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.TESTNET_S3_SECRET_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.TESTNET_S3_REGION }}
        run: |
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set region "$AWS_DEFAULT_REGION"

      - name: Create directories
        run: |
          mkdir -p reports
          mkdir -p test/load/logs

      - name: Run Artillery test
        id: run_test
        env:
          ARTILLERY_API_KEY: ${{ secrets.QA_ARTILLERY_API_KEY }}
          SIGNET_API_KEY: ${{ secrets.QA_SIGNET_API_KEY }}
          MAINNET_API_KEY: ${{ secrets.QA_MAINNET_API_KEY }}
          SIGNET_API_URL: ${{ secrets.QA_SIGNET_API_URL }}
          MAINNET_API_URL: ${{ secrets.QA_MAINNET_API_URL }}
        run: |
          TS=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          ENV="${{ inputs.environment }}"
          TEST="${{ matrix.test-case }}"

          # File paths (relative to repo root)
          JSON_REPORT="reports/${TEST}-${ENV}-${TS}.json"
          ERROR_REPORT="reports/${TEST}-${ENV}-${TS}-errors.csv"
          DETAILED_ERROR_LOG="reports/${TEST}-${ENV}-${TS}-detailed-errors.log"
          PROCESSOR_LOG_DIR="test/load/logs/${TEST}-${ENV}-${TS}"
          S3_JSON="s3://${{ secrets.TESTNET_S3_BUCKET_NAME }}/${ENV}/json/${TEST}-${ENV}-${TS}.json"
          S3_DETAILED="s3://${{ secrets.TESTNET_S3_BUCKET_NAME }}/${ENV}/logs/${TEST}-${ENV}-${TS}-detailed-errors.log"
          S3_PROCESSOR_LOGS="s3://${{ secrets.TESTNET_S3_BUCKET_NAME }}/${ENV}/processor-logs/${TEST}-${ENV}-${TS}/"
          CONFIG="test/load/configs/${TEST}.yml"

          # Set environment variables
          if [[ "$ENV" == "signet" ]]; then
            export API_URL="$SIGNET_API_URL"
            export API_KEY="$SIGNET_API_KEY"
          else
            export API_URL="$MAINNET_API_URL"
            export API_KEY="$MAINNET_API_KEY"
          fi

          # Run Artillery with full logging
          echo "▶ Starting load test: ${TEST} on ${ENV}"
          artillery run \
            --environment "$ENV" \
            --record --key "$ARTILLERY_API_KEY" \
            --output "$JSON_REPORT" \
            --include-response-body \
            --include-request-body \
            --config "test/load/configs/artillery-config.yml" \
            "$CONFIG"

          # Generate error reports
          echo "⚡ Generating error reports..."

          # CSV error report
          jq -r '
            ["status_code", "error_type", "count"],
            (.aggregate.codes | to_entries[] | 
              [.key, 
              (if .key >= 500 then "server-error" 
               elif .key >= 400 then "client-error" 
               else "other" end), 
              .value] | @csv)
          ' "$JSON_REPORT" > "$ERROR_REPORT"

          # Detailed error log from Artillery JSON
          jq --arg env "$ENV" -r '
            (.intermediate // [])[] | 
            select(.response.status >= 400) |
            "==========================\n" +
            "[\(.timestamp)]\n" +
            "Environment: \($env)\n" +
            "Status: \(.response.status)\n" +
            "URL: \(.request.url // "unknown")\n" +
            "Request Body:\n\(.request.json? // {} | tojson)\n" +
            "Response Body:\n\(.response.body | if type != "string" then tojson else . end)\n"
          ' "$JSON_REPORT" > "$DETAILED_ERROR_LOG"

          # Copy processor logs (including subdirectories)
          mkdir -p "$PROCESSOR_LOG_DIR"
          find test/load/logs -name '*.log' -exec cp --parents {} "$PROCESSOR_LOG_DIR" \;

          # Finalize error log
          if [ -s "$DETAILED_ERROR_LOG" ]; then
            echo -e "\n==========================" >> "$DETAILED_ERROR_LOG"
          else
            echo "No errors detected during test" > "$DETAILED_ERROR_LOG"
          fi

          # Save outputs
          echo "report_id=$(jq -r '.metadata."artillery.io/record".id' "$JSON_REPORT")" >> $GITHUB_OUTPUT
          echo "json_path=$JSON_REPORT" >> $GITHUB_OUTPUT
          echo "error_path=$ERROR_REPORT" >> $GITHUB_OUTPUT
          echo "detailed_error_path=$DETAILED_ERROR_LOG" >> $GITHUB_OUTPUT
          echo "processor_logs_dir=$PROCESSOR_LOG_DIR" >> $GITHUB_OUTPUT
          echo "s3_json=$S3_JSON" >> $GITHUB_OUTPUT
          echo "s3_detailed=$S3_DETAILED" >> $GITHUB_OUTPUT
          echo "s3_processor_logs=$S3_PROCESSOR_LOGS" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: load-test-${{ matrix.test-case }}-${{ inputs.environment }}-${{ steps.run_test.outputs.timestamp }}
          path: |
            ${{ steps.run_test.outputs.json_path }}
            ${{ steps.run_test.outputs.error_path }}
            ${{ steps.run_test.outputs.detailed_error_path }}
            ${{ steps.run_test.outputs.processor_logs_dir }}/*

      - name: Upload to S3
        run: |
          aws s3 cp "${{ steps.run_test.outputs.json_path }}" "${{ steps.run_test.outputs.s3_json }}"
          aws s3 cp "${{ steps.run_test.outputs.detailed_error_path }}" "${{ steps.run_test.outputs.s3_detailed }}"
          aws s3 sync "${{ steps.run_test.outputs.processor_logs_dir }}" "${{ steps.run_test.outputs.s3_processor_logs }}"

      - name: Cleanup
        run: |
          rm -rf reports/
          rm -rf test/load/logs/*

      - name: Show report URLs
        run: |
          echo "✅ Artillery Dashboard: https://app.artillery.io/reports/${{ steps.run_test.outputs.report_id }}"
          echo "📄 JSON Report: ${{ steps.run_test.outputs.json_path }}"
          echo "❌ Error Report: ${{ steps.run_test.outputs.error_path }}"
          echo "📝 Detailed Error Log: ${{ steps.run_test.outputs.detailed_error_path }}"
          echo "🔧 Processor Logs: ${{ steps.run_test.outputs.s3_processor_logs }}"