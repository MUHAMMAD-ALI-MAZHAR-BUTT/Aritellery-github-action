name: Load Test Runner

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (signet/mainnet)"
        required: true
        type: choice
        options: [signet, mainnet]
      test-case:
        description: "Test config filename (without .yml)"
        required: true
        type: string
        default: "offer-creation-mint-test"

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # checkout your feature branch where the workflow lives
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Setup Node.js & Artillery
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
      - run: |
          npm install -g artillery@latest

      - name: Install project dependencies
        run: npm ci

      - name: Configure AWS CLI
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.TESTNET_S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.TESTNET_S3_SECRET_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.TESTNET_S3_REGION }}
        run: |
          aws configure set aws_access_key_id    "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set region                "$AWS_DEFAULT_REGION"

      - name: Run Artillery Pro load test
        id: run_test
        env:
          ARTILLERY_API_KEY: ${{ secrets.QA_ARTILLERY_API_KEY }}
          SIGNET_API_KEY: ${{ secrets.QA_SIGNET_API_KEY }}
          MAINNET_API_KEY: ${{ secrets.QA_MAINNET_API_KEY }}
          SIGNET_API_URL: ${{ secrets.QA_SIGNET_API_URL }}
          MAINNET_API_URL: ${{ secrets.QA_MAINNET_API_URL }}
        run: |
          set -e
          TS=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
          ENV="${{ inputs.environment }}"
          TEST="${{ inputs.test-case }}"
          JSON="reports/${TEST}-${ENV}-${TS}.json"
          HTML="reports/${TEST}-${ENV}-${TS}.html"
          S3_JSON="s3://${{ secrets.TESTNET_S3_BUCKET_NAME }}/${ENV}/json/${TEST}-${ENV}-${TS}.json"
          S3_HTML="s3://${{ secrets.TESTNET_S3_BUCKET_NAME }}/${ENV}/html/${TEST}-${ENV}-${TS}.html"
          CONFIG="test/load/configs/${TEST}.yml"

          mkdir -p reports

          if [[ ! -f "$CONFIG" ]]; then
            echo "‚ùå Config not found: $CONFIG"
            exit 1
          fi

          # choose API endpoint
          if [[ "$ENV" == "signet" ]]; then
            export API_URL="$SIGNET_API_URL"
            export API_KEY="$SIGNET_API_KEY"
          else
            export API_URL="$MAINNET_API_URL"
            export API_KEY="$MAINNET_API_KEY"
          fi

          echo "‚ñ∂ Running Artillery test [$TEST] against $ENV..."
          artillery run \
            --environment "$ENV" \
            --record --key "$ARTILLERY_API_KEY" \
            --output "$JSON" \
            "$CONFIG"

          echo "‚ñ∂ Generating local HTML report..."
          artillery report \
            --output "$HTML" \
            "$JSON"

          # capture report ID for the cloud link
          REPORT_ID=$(jq -r '.metadata."artillery.io/record".id' "$JSON")
          echo "::set-output name=report_id::$REPORT_ID"
          echo "::set-output name=json_path::$JSON"
          echo "::set-output name=html_path::$HTML"
          echo "::set-output name=s3_json::$S3_JSON"
          echo "::set-output name=s3_html::$S3_HTML"

      - name: Upload JSON & HTML as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: load-test-reports
          path: reports/*

      - name: Upload reports to S3
        run: |
          aws s3 cp "${{ steps.run_test.outputs.json_path }}" "${{ steps.run_test.outputs.s3_json }}"
          aws s3 cp "${{ steps.run_test.outputs.html_path }}" "${{ steps.run_test.outputs.s3_html }}"

      - name: Announce report URLs
        run: |
          echo "‚úÖ Artillery Pro Dashboard: https://app.artillery.io/reports/${{ steps.run_test.outputs.report_id }}"
          echo "üìÑ S3 HTML Report: https://${{ secrets.TESTNET_S3_BUCKET_NAME }}.s3.${{ secrets.TESTNET_S3_REGION }}.amazonaws.com/${{ inputs.environment }}/html/$(basename "${{ steps.run_test.outputs.html_path }}")"
